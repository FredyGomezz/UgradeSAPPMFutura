<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Proyectos - PDT Futura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: radial-gradient(ellipse at center, #0f0f23 0%, #000000 100%);
            color: white;
            padding: 20px;
            position: relative;
            min-height: 100vh;
        }
        
        /* Marca de agua del logo */
        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-image: url('logo_2025web.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 400px;
            height: 200px;
            opacity: 0.1;
            pointer-events: none;
            z-index: -1;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        #project-list {
            list-style: none;
            padding: 0;
        }
        #project-list li {
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .project-info {
            flex: 1;
        }
        .project-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .project-action-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
            position: relative;
        }
        .project-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: scale(1.1);
        }
        .project-action-btn.admin-only {
            display: none;
        }
        .project-action-btn.admin-only.show {
            display: block;
        }
        .project-action-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .project-action-btn:hover::after {
            opacity: 1;
        }
        #project-list a {
            color: #87cefa;
            text-decoration: none;
            font-weight: bold;
        }
        .admin-controls {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.4);
        }
        
        /* Estilos para el modal de usuarios */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.show { 
            opacity: 1; 
            visibility: visible; 
        }
        .modal-content { 
            background: white; 
            border-radius: 15px; 
            padding: 25px; 
            max-width: 600px; 
            max-height: 80vh; 
            overflow-y: auto; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            transform: scale(0.9); 
            transition: transform 0.3s ease; 
            color: #2c3e50;
        }
        .modal-overlay.show .modal-content { 
            transform: scale(1); 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid #ecf0f1; 
        }
        .modal-header h3 { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #2c3e50; 
            margin: 0; 
        }
        .close-modal-btn { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: #7f8c8d; 
            padding: 5px; 
            border-radius: 50%; 
            transition: all 0.3s ease; 
        }
        .close-modal-btn:hover { 
            background: #f8f9fa; 
            color: #2c3e50; 
        }
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }
        .users-list {
            margin-bottom: 30px;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #bdc3c7;
        }
        .user-item.admin {
            border-left-color: #e74c3c;
        }
        .user-info {
            flex: 1;
        }
        .user-email {
            font-weight: bold;
            color: #2c3e50;
        }
        .user-role {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 2px;
        }
        .user-actions {
            display: flex;
            gap: 10px;
        }
        .user-action-btn {
            background: none;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        .user-action-btn.edit {
            background: #3498db;
            color: white;
        }
        .user-action-btn.edit:hover {
            background: #2980b9;
        }
        .user-action-btn.delete {
            background: #e74c3c;
            color: white;
        }
        .user-action-btn.delete:hover {
            background: #c0392b;
        }
        .add-user-form {
            border-top: 1px solid #ecf0f1;
            padding-top: 20px;
        }
        .add-user-form h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        .modal-actions {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        #user-controls {
            text-align: left;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            align-items: center;
        }
        #user-controls .btn {
            margin: 0;
        }
    </style>
</head>
<body>
        <div class="container">
            <div class="header">
                <h1>Proyectos Disponibles</h1>
            </div>
            
            <div id="debug-info" style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9em;">
                <strong>Información de Debug:</strong><br>
                <span id="user-info">Usuario: Cargando...</span><br>
                <span id="connection-status">Conexión: Verificando...</span><br>
                <span id="project-count">Proyectos encontrados: 0</span>
            </div>
            
            <div id="error-message" style="display: none; background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center;">
                <p id="error-text" style="color: #ff6b6b; margin: 0;"></p>
                <button id="retry-btn" class="btn" style="margin-top: 10px; background: #ff6b6b;">Reintentar</button>
            </div>
            
            <div id="user-controls" style="display: none;">
                <a href="GenerarProy.html" class="btn admin-only" id="create-project-btn">Generar Nuevo Proyecto</a>
                <button id="logout-btn" class="btn logout-btn">Cerrar Sesión</button>
            </div>

            <ul id="project-list">
                <!-- La lista de proyectos se cargará aquí desde Firebase -->
                <li><a href="intro.html?id=default">Proyecto de Muestra (intro.html)</a></li>
            </ul>
        </div>

        <!-- Modal para gestionar usuarios del proyecto -->
        <div id="users-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Gestionar Usuarios - Proyecto</h3>
                    <button id="close-users-modal" class="close-modal-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-actions" style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="toggleDebugInfo()" class="btn" style="background: #3498db; font-size: 0.8rem; padding: 5px 10px;">
                            <i class="fas fa-bug"></i> Debug
                        </button>
                        <button onclick="cleanUserData(currentProjectId)" class="btn" style="background: #f39c12; font-size: 0.8rem; padding: 5px 10px;">
                            <i class="fas fa-broom"></i> Limpiar Proyecto
                        </button>
                        <button onclick="cleanAllProjectUsers()" class="btn" style="background: #e67e22; font-size: 0.8rem; padding: 5px 10px;">
                            <i class="fas fa-broom"></i> Limpiar Todos
                        </button>
                    </div>
                    <div class="users-list" id="users-list">
                        <!-- Lista de usuarios se cargará aquí -->
                    </div>
                    <div class="add-user-form">
                        <h4>Agregar Nuevo Usuario</h4>
                        <div class="form-group">
                            <input type="email" id="new-user-email" placeholder="Correo electrónico" required>
                        </div>
                        <div class="form-group">
                            <input type="password" id="new-user-password" placeholder="Contraseña" required>
                        </div>
                        <div class="form-group">
                            <select id="new-user-role" required>
                                <option value="">Seleccionar rol</option>
                                <option value="usuario">Usuario Estándar</option>
                                <option value="administrador">Administrador</option>
                            </select>
                        </div>
                        <button id="add-user-btn" class="btn">Agregar Usuario</button>
                        <button id="cancel-add-user" class="btn" style="background: #95a5a6; margin-left: 10px;">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBX1H8MaD6eoIo0jbpVRKO-fGtND3PthlI",
            authDomain: "pdt-futura.firebaseapp.com",
            projectId: "pdt-futura",
            storageBucket: "pdt-futura.appspot.com",
            messagingSenderId: "807986666483",
            appId: "1:807986666483:web:4213a33d83132845c87931"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                currentUser = user;
                console.log('Usuario autenticado:', currentUser.email);
                console.log('UID del usuario:', currentUser.uid);
                
                // Actualizar info de debug
                document.getElementById('user-info').textContent = `Usuario: ${currentUser.email}`;
                
                // Verificar conexión a Firestore
                console.log('Verificando conexión a Firestore...');
                document.getElementById('connection-status').textContent = 'Conexión: Verificando...';
                
                db.collection('projects').limit(1).get()
                    .then(snapshot => {
                        console.log('Conexión a Firestore exitosa');
                        document.getElementById('connection-status').textContent = 'Conexión: OK';
                        hideError();
                        
                        // Mostrar controles de usuario para todos los usuarios autenticados
                        document.getElementById('user-controls').style.display = 'flex';
                        
                        // Verificar si el usuario puede crear proyectos (admin global o admin de algún proyecto)
                        checkUserCanCreateProjects()
                            .then(canCreate => {
                                if (canCreate) {
                                    document.getElementById('create-project-btn').style.display = 'inline-block';
                                } else {
                                    document.getElementById('create-project-btn').style.display = 'none';
                                }
                            })
                            .catch(error => {
                                console.error('Error al verificar permisos de creación:', error);
                                // Por defecto, ocultar el botón si hay error
                                document.getElementById('create-project-btn').style.display = 'none';
                            });

                        // Cargar la lista de proyectos desde Firestore
                        loadProjects();
                    })
                    .catch(error => {
                        console.error('Error de conexión a Firestore:', error);
                        document.getElementById('connection-status').textContent = 'Conexión: Error';
                        showError('Error de conexión a la base de datos. Verifica tu conexión a internet.');
                    });

            } else {
                // No user is signed in.
                console.log('Usuario no autenticado. Redirigiendo a login...');
                document.getElementById('user-info').textContent = 'Usuario: No autenticado';
                document.getElementById('connection-status').textContent = 'Conexión: N/A';
                window.location.href = 'login.html';
            }
        });

        function deleteProject(projectId, projectName) {
            // Verificar si el usuario tiene permisos para eliminar este proyecto
            checkProjectAdminPermission(projectId)
                .then(hasPermission => {
                    if (!hasPermission) {
                        alert('No tienes permisos para eliminar proyectos.');
                        return;
                    }

                    if (confirm(`¿Estás seguro de que quieres eliminar el proyecto "${projectName}"? Esta acción no se puede deshacer.`)) {
                        db.collection('projects').doc(projectId).delete()
                            .then(() => {
                                console.log('Proyecto eliminado exitosamente');
                                alert('Proyecto eliminado exitosamente.');
                                loadProjects(); // Recargar la lista
                            })
                            .catch(error => {
                                console.error('Error al eliminar el proyecto:', error);
                                alert('Error al eliminar el proyecto. Inténtalo de nuevo.');
                            });
                    }
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos.');
                });
        }

        function backupProject(projectId, projectName) {
            // Verificar si el usuario tiene permisos para hacer backup de este proyecto
            checkProjectAdminPermission(projectId)
                .then(hasPermission => {
                    if (!hasPermission) {
                        alert('No tienes permisos para hacer copias de seguridad.');
                        return;
                    }

                    // Obtener los datos del proyecto
                    db.collection('projects').doc(projectId).get()
                        .then(doc => {
                            if (doc.exists) {
                                const projectData = doc.data();
                                
                                // Crear un objeto con la información del backup
                                const backupData = {
                                    projectId: projectId,
                                    projectName: projectData.projectName,
                                    backupDate: new Date().toISOString(),
                                    data: projectData
                                };

                                // Convertir a JSON y descargar como archivo
                                const dataStr = JSON.stringify(backupData, null, 2);
                                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                                
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(dataBlob);
                                link.download = `${projectName.replace(/[^a-zA-Z0-9]/g, '_')}_backup_${new Date().toISOString().split('T')[0]}.json`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                console.log('Copia de seguridad descargada exitosamente');
                            } else {
                                alert('Proyecto no encontrado.');
                            }
                        })
                        .catch(error => {
                            console.error('Error al crear la copia de seguridad:', error);
                            alert('Error al crear la copia de seguridad. Inténtalo de nuevo.');
                        });
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos.');
                });
        }

        function restoreProject(projectId, projectName) {
            // Verificar si el usuario tiene permisos para restaurar este proyecto
            checkProjectAdminPermission(projectId)
                .then(hasPermission => {
                    if (!hasPermission) {
                        alert('No tienes permisos para restaurar copias de seguridad.');
                        return;
                    }

                    // Crear input file oculto para seleccionar el archivo
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.style.display = 'none';
                    
                    fileInput.onchange = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;
                        
                        // Validar que sea un archivo JSON
                        if (!file.name.toLowerCase().endsWith('.json')) {
                            alert('Por favor, selecciona un archivo JSON de backup válido.');
                            return;
                        }
                        
                        // Leer el archivo
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const backupData = JSON.parse(e.target.result);
                                
                                // Validar estructura del backup
                                if (!backupData.projectId || !backupData.data || !backupData.backupDate) {
                                    alert('El archivo seleccionado no es un backup válido. Falta información requerida.');
                                    return;
                                }
                                
                                // Verificar que el backup corresponda al proyecto correcto
                                if (backupData.projectId !== projectId) {
                                    alert(`Este backup pertenece al proyecto "${backupData.projectName}" pero estás intentando restaurarlo en "${projectName}".\n\nPor favor, selecciona el backup correcto para este proyecto.`);
                                    return;
                                }
                                
                                // Mostrar confirmación detallada
                                const confirmMessage = `
¿Estás seguro de que quieres restaurar este backup?

Proyecto: ${projectName}
Fecha del backup: ${formatDate(backupData.backupDate)}
Usuario actual: ${currentUser.email}

⚠️ ADVERTENCIA: Esta acción sobrescribirá todos los datos actuales del proyecto.
Se recomienda hacer un backup antes de restaurar.

¿Continuar con la restauración?`;
                                
                                if (!confirm(confirmMessage)) {
                                    return;
                                }
                                
                                // Mostrar indicador de carga
                                const loadingIndicator = document.createElement('div');
                                loadingIndicator.id = 'restore-loading';
                                loadingIndicator.innerHTML = `
                                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                               background: rgba(0,0,0,0.7); z-index: 9999; 
                                               display: flex; align-items: center; justify-content: center;">
                                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                                            <div style="margin-bottom: 15px;">
                                                <div style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; 
                                                           border-radius: 50%; width: 30px; height: 30px; 
                                                           animation: spin 1s linear infinite; margin: 0 auto;"></div>
                                            </div>
                                            <p>Restaurando proyecto desde backup...</p>
                                            <p style="font-size: 0.9em; color: #666;">Esto puede tomar unos momentos</p>
                                        </div>
                                    </div>
                                    <style>
                                        @keyframes spin {
                                            0% { transform: rotate(0deg); }
                                            100% { transform: rotate(360deg); }
                                        }
                                    </style>
                                `;
                                document.body.appendChild(loadingIndicator);
                                
                                // Preparar datos para restaurar
                                const restoredData = {
                                    ...backupData.data,
                                    lastBackupRestoredAt: firebase.firestore.Timestamp.now(),
                                    lastBackupRestoredBy: currentUser.email,
                                    lastUpdated: firebase.firestore.Timestamp.now()
                                };
                                
                                // Restaurar el proyecto
                                db.collection('projects').doc(projectId).set(restoredData)
                                    .then(() => {
                                        console.log('Proyecto restaurado exitosamente desde backup');
                                        
                                        // Remover indicador de carga
                                        const loading = document.getElementById('restore-loading');
                                        if (loading) {
                                            document.body.removeChild(loading);
                                        }
                                        
                                        showSuccess(`Proyecto "${projectName}" restaurado exitosamente desde backup del ${formatDate(backupData.backupDate)}`);
                                        
                                        // Recargar la lista de proyectos
                                        loadProjects();
                                    })
                                    .catch(error => {
                                        console.error('Error al restaurar el proyecto:', error);
                                        
                                        // Remover indicador de carga
                                        const loading = document.getElementById('restore-loading');
                                        if (loading) {
                                            document.body.removeChild(loading);
                                        }
                                        
                                        alert('Error al restaurar el proyecto. Inténtalo de nuevo.');
                                    });
                                
                            } catch (error) {
                                console.error('Error al procesar el archivo de backup:', error);
                                alert('Error al leer el archivo de backup. Asegúrate de que sea un archivo JSON válido.');
                            }
                        };
                        
                        reader.readAsText(file);
                    };
                    
                    // Agregar al DOM y hacer clic para abrir el selector
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    
                    // Limpiar después de un tiempo
                    setTimeout(() => {
                        if (fileInput.parentNode) {
                            document.body.removeChild(fileInput);
                        }
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos.');
                });
        }

        function viewProject(projectId) {
            // Redirigir a vistaProyecto.html con el ID del proyecto
            window.location.href = `vistaProyecto.html?id=${projectId}`;
        }

        function downloadSummary(projectId) {
            // Mostrar indicador de carga
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'pdf-loading';
            loadingIndicator.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                           background: rgba(0,0,0,0.7); z-index: 9999; 
                           display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="margin-bottom: 15px;">
                            <div style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; 
                                       border-radius: 50%; width: 30px; height: 30px; 
                                       animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                        <p>Generando PDF del proyecto...</p>
                        <p style="font-size: 0.9em; color: #666;">Esto puede tomar unos momentos</p>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.appendChild(loadingIndicator);

            // Crear iframe oculto para cargar la página y activar la descarga automática
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = `vistaProyecto.html?id=${projectId}&download=pdf`;
            
            // Escuchar mensajes del iframe para saber cuándo termina
            const messageHandler = (event) => {
                if (event.data && event.data.type === 'pdf-download-complete') {
                    // Remover indicador de carga
                    const loading = document.getElementById('pdf-loading');
                    if (loading) {
                        document.body.removeChild(loading);
                    }
                    
                    // Remover iframe
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                    
                    // Remover el event listener
                    window.removeEventListener('message', messageHandler);
                    
                    // Mostrar mensaje de éxito
                    showSuccess('PDF generado y descargado exitosamente');
                }
            };
            
            window.addEventListener('message', messageHandler);
            document.body.appendChild(iframe);
            
            // Timeout de seguridad para remover elementos si algo falla
            setTimeout(() => {
                const loading = document.getElementById('pdf-loading');
                if (loading) {
                    document.body.removeChild(loading);
                    showError('Tiempo de espera agotado. Inténtalo nuevamente.');
                }
                if (iframe.parentNode) {
                    document.body.removeChild(iframe);
                }
                window.removeEventListener('message', messageHandler);
            }, 30000); // 30 segundos timeout
        }

        function loadProjects() {
            const projectList = document.getElementById('project-list');
            
            // Limpiar la lista actual (mantener solo el proyecto de muestra)
            projectList.innerHTML = '<li><a href="intro.html?id=default">Proyecto de Muestra (intro.html)</a></li>';
            
            console.log('Intentando cargar proyectos desde Firestore...');
            
            // Obtener proyectos desde Firestore
            db.collection('projects').get()
                .then(querySnapshot => {
                    console.log('Consulta exitosa. Número de documentos:', querySnapshot.size);
                    document.getElementById('project-count').textContent = `Proyectos: ${querySnapshot.size}`;
                    
                    let visibleProjectsCount = 0;
                    
                    querySnapshot.forEach(doc => {
                        const projectData = doc.data();
                        const projectId = doc.id;
                        
                        console.log('Proyecto encontrado:', projectId, projectData.projectName);
                        
                        // Verificar si el usuario actual tiene acceso a este proyecto
                        const isAdmin = currentUser.email === 'admin@gnce.com';
                        const authorizedUsers = projectData.authorizedUsers || [];
                        
                        console.log(`Verificando acceso para ${currentUser.email} al proyecto ${projectData.projectName}:`);
                        console.log('- Es admin:', isAdmin);
                        console.log('- authorizedUsers:', authorizedUsers);
                        
                        let isAuthorized = false;
                        let isCreator = false;
                        let isProjectAdmin = false;
                        
                        // Si no hay usuarios autorizados, solo el admin puede ver el proyecto
                        if (authorizedUsers.length === 0) {
                            console.log('- No hay usuarios autorizados, solo admin puede ver');
                            if (!isAdmin) {
                                console.log('Usuario no autorizado para ver el proyecto (sin authorizedUsers):', projectId);
                                return; // Saltar este proyecto
                            }
                        } else {
                            // Verificar si el usuario está autorizado y determinar su rol
                            authorizedUsers.forEach(user => {
                                let userEmail = '';
                                let userRole = 'usuario';
                                
                                if (typeof user === 'string') {
                                    userEmail = user.toLowerCase();
                                } else if (typeof user === 'object' && user !== null) {
                                    userEmail = (user.email || user.correo || user.usuario || '').toLowerCase();
                                    userRole = user.role || user.rol || 'usuario';
                                }
                                
                                if (userEmail === currentUser.email.toLowerCase()) {
                                    isAuthorized = true;
                                    if (userRole === 'administrador' || userRole === 'admin') {
                                        isProjectAdmin = true;
                                    }
                                }
                            });
                            
                            isCreator = projectData.createdBy === currentUser.email;
                            console.log('- Está autorizado:', isAuthorized);
                            console.log('- Es administrador del proyecto:', isProjectAdmin);
                            console.log('- Es creador:', isCreator);
                            console.log('- Acceso final:', isAdmin || isAuthorized || isCreator);
                            
                            // Solo mostrar el proyecto si el usuario es admin, está autorizado, o es el creador
                            if (!isAdmin && !isAuthorized && !isCreator) {
                                console.log('Usuario no autorizado para ver el proyecto:', projectId);
                                return; // Saltar este proyecto
                            }
                        }
                        
                        console.log(`PROYECTO MOSTRADO: ${projectData.projectName} (ID: ${projectId})`);
                        console.log(`- Usuario actual: ${currentUser.email}`);
                        console.log(`- Es admin global: ${isAdmin}`);
                        console.log(`- Es admin del proyecto: ${isProjectAdmin}`);
                        console.log(`- Authorized users:`, authorizedUsers);
                        console.log(`- Usuario autorizado: ${isAuthorized}`);
                        console.log(`- Es creador: ${isCreator}`);
                        console.log(`---`);
                        
                        // Determinar si mostrar botones de admin para este proyecto
                        const showAdminButtons = isAdmin || isProjectAdmin;
                        
                        // Crear elemento de lista para el proyecto
                        const li = document.createElement('li');
                        
                        // Información del proyecto
                        const projectInfo = document.createElement('div');
                        projectInfo.className = 'project-info';
                        
                        // Preparar información de backup
                        let backupInfo = '';
                        if (projectData.lastBackupRestoredAt && projectData.lastBackupRestoredBy) {
                            backupInfo = ` | Último backup restaurado: ${formatDate(projectData.lastBackupRestoredAt)} por ${projectData.lastBackupRestoredBy}`;
                        }
                        
                        projectInfo.innerHTML = `
                            <strong>${projectData.projectName}</strong><br>
                            <small>Creado: ${formatDate(projectData.createdAt)} | 
                            Última actualización: ${formatDate(projectData.lastUpdated)}${backupInfo}</small>
                        `;
                        
                        // Botones de acciones
                        const projectActions = document.createElement('div');
                        projectActions.className = 'project-actions';
                        
                        // Botón Ver Proyecto
                        const viewBtn = document.createElement('button');
                        viewBtn.className = 'project-action-btn';
                        viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                        viewBtn.setAttribute('data-tooltip', 'Ver Proyecto');
                        viewBtn.onclick = () => viewProject(projectId);
                        
                        // Botón Descargar Resumen
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'project-action-btn';
                        downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                        downloadBtn.setAttribute('data-tooltip', 'Descargar Resumen PDF');
                        downloadBtn.onclick = () => downloadSummary(projectId);
                        
                        // Botón Copia Local (solo admin)
                        const backupBtn = document.createElement('button');
                        backupBtn.className = `project-action-btn admin-only ${showAdminButtons ? 'show' : ''}`;
                        backupBtn.innerHTML = '<i class="fas fa-copy"></i>';
                        backupBtn.setAttribute('data-tooltip', 'Hacer Copia Local (Backup)');
                        backupBtn.onclick = () => backupProject(projectId, projectData.projectName);
                        
                        // Botón Eliminar Proyecto (solo admin)
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = `project-action-btn admin-only ${showAdminButtons ? 'show' : ''}`;
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.setAttribute('data-tooltip', 'Eliminar Proyecto');
                        deleteBtn.onclick = () => deleteProject(projectId, projectData.projectName);
                        
                        // Botón Gestionar Usuarios (solo admin)
                        const manageUsersBtn = document.createElement('button');
                        manageUsersBtn.className = `project-action-btn admin-only ${showAdminButtons ? 'show' : ''}`;
                        manageUsersBtn.innerHTML = '<i class="fas fa-users"></i>';
                        manageUsersBtn.setAttribute('data-tooltip', 'Gestionar Usuarios Autorizados');
                        manageUsersBtn.onclick = () => manageProjectUsers(projectId, projectData.projectName);
                        
                        // Botón Recuperar Copia Local (solo admin)
                        const restoreBtn = document.createElement('button');
                        restoreBtn.className = `project-action-btn admin-only ${showAdminButtons ? 'show' : ''}`;
                        restoreBtn.innerHTML = '<i class="fas fa-upload"></i>';
                        restoreBtn.setAttribute('data-tooltip', 'Recuperar Copia Local (Restaurar Backup)');
                        restoreBtn.onclick = () => restoreProject(projectId, projectData.projectName);
                        
                        // Agregar botones a las acciones
                        projectActions.appendChild(viewBtn);
                        projectActions.appendChild(downloadBtn);
                        projectActions.appendChild(manageUsersBtn);
                        projectActions.appendChild(restoreBtn);
                        projectActions.appendChild(backupBtn);
                        projectActions.appendChild(deleteBtn);
                        
                        // Agregar información y acciones al elemento de lista
                        li.appendChild(projectInfo);
                        li.appendChild(projectActions);
                        
                        // Agregar el elemento a la lista
                        projectList.appendChild(li);
                        visibleProjectsCount++;
                    });
                    
                    // Los botones de admin ahora se muestran individualmente por proyecto
                    // No es necesario mostrar todos los botones admin al final
                    
                    console.log('Proyectos cargados exitosamente. Total:', querySnapshot.size, 'Visibles:', visibleProjectsCount);
                    document.getElementById('project-count').textContent = `Proyectos: ${visibleProjectsCount} (de ${querySnapshot.size} total)`;
                    
                    hideError();
                })
                .catch(error => {
                    console.error('Error al cargar proyectos:', error);
                    console.error('Código de error:', error.code);
                    console.error('Mensaje de error:', error.message);
                    document.getElementById('project-count').textContent = 'Proyectos: Error';
                    
                    // Mostrar mensaje de error en la página
                    const errorMessage = error.message || 'Error desconocido al cargar proyectos';
                    showError(`Error al cargar proyectos: ${errorMessage}`);
                });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            // Crear elemento de éxito si no existe
            let successDiv = document.getElementById('success-message');
            if (!successDiv) {
                successDiv = document.createElement('div');
                successDiv.id = 'success-message';
                successDiv.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 1000;
                    background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;
                    padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    display: none; max-width: 350px;
                `;
                document.body.appendChild(successDiv);
            }
            
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            // Auto-hide después de 3 segundos
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function hideError() {
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'none';
        }

        function formatDate(dateValue) {
            if (!dateValue) return 'N/A';
            
            try {
                // Si es un Timestamp de Firestore (tiene método toDate)
                if (typeof dateValue.toDate === 'function') {
                    return dateValue.toDate().toLocaleDateString('es-ES');
                }
                
                // Si es un string o número, intentar convertirlo
                if (typeof dateValue === 'string' || typeof dateValue === 'number') {
                    const date = new Date(dateValue);
                    return isNaN(date.getTime()) ? 'N/A' : date.toLocaleDateString('es-ES');
                }
                
                // Si ya es un objeto Date
                if (dateValue instanceof Date) {
                    return dateValue.toLocaleDateString('es-ES');
                }
                
                return 'N/A';
            } catch (error) {
                console.warn('Error formateando fecha:', error, dateValue);
                return 'N/A';
            }
        }

        // Event listener para el botón de reintentar
        document.getElementById('retry-btn').addEventListener('click', () => {
            hideError();
            if (currentUser) {
                loadProjects();
            }
        });

        // Funciones para gestionar usuarios del proyecto
        let currentProjectId = null;

        function checkProjectAdminPermission(projectId) {
            return new Promise((resolve, reject) => {
                // Si es el admin global, tiene permisos para todo
                if (currentUser && currentUser.email === 'admin@gnce.com') {
                    resolve(true);
                    return;
                }

                // Verificar si el usuario es admin de este proyecto específico
                db.collection('projects').doc(projectId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const projectData = doc.data();
                            const authorizedUsers = projectData.authorizedUsers || [];
                            
                            // Buscar al usuario actual en la lista de autorizados
                            const currentUserInProject = authorizedUsers.find(user => {
                                if (typeof user === 'string') {
                                    return user.toLowerCase() === currentUser.email.toLowerCase();
                                } else if (typeof user === 'object' && user !== null) {
                                    const userEmail = (user.email || user.correo || user.usuario || '').toLowerCase();
                                    return userEmail === currentUser.email.toLowerCase();
                                }
                                return false;
                            });
                            
                            // Verificar si es administrador del proyecto
                            if (currentUserInProject && typeof currentUserInProject === 'object') {
                                const userRole = currentUserInProject.role || currentUserInProject.rol || 'usuario';
                                resolve(userRole === 'administrador' || userRole === 'admin');
                            } else {
                                resolve(false);
                            }
                        } else {
                            resolve(false);
                        }
                    })
                    .catch(error => {
                        console.error('Error al verificar permisos de proyecto:', error);
                        reject(error);
                    });
            });
        }

        function checkUserCanCreateProjects() {
            return new Promise((resolve, reject) => {
                // Si es el admin global, puede crear proyectos
                if (currentUser && currentUser.email === 'admin@gnce.com') {
                    console.log('Usuario es admin global - puede crear proyectos');
                    resolve(true);
                    return;
                }

                // Verificar si el usuario es administrador de al menos un proyecto
                console.log('Verificando si el usuario es admin de algún proyecto...');
                db.collection('projects').get()
                    .then(querySnapshot => {
                        let isAdminOfAnyProject = false;
                        
                        querySnapshot.forEach(doc => {
                            const projectData = doc.data();
                            const authorizedUsers = projectData.authorizedUsers || [];
                            
                            // Buscar al usuario actual en la lista de autorizados
                            const currentUserInProject = authorizedUsers.find(user => {
                                if (typeof user === 'string') {
                                    return user.toLowerCase() === currentUser.email.toLowerCase();
                                } else if (typeof user === 'object' && user !== null) {
                                    const userEmail = (user.email || user.correo || user.usuario || '').toLowerCase();
                                    return userEmail === currentUser.email.toLowerCase();
                                }
                                return false;
                            });
                            
                            // Verificar si es administrador del proyecto
                            if (currentUserInProject && typeof currentUserInProject === 'object') {
                                const userRole = currentUserInProject.role || currentUserInProject.rol || 'usuario';
                                if (userRole === 'administrador' || userRole === 'admin') {
                                    isAdminOfAnyProject = true;
                                    console.log(`Usuario es admin del proyecto: ${projectData.projectName}`);
                                }
                            }
                        });
                        
                        console.log(`Usuario puede crear proyectos: ${isAdminOfAnyProject}`);
                        resolve(isAdminOfAnyProject);
                    })
                    .catch(error => {
                        console.error('Error al verificar permisos de creación de proyectos:', error);
                        reject(error);
                    });
            });
        }

        function manageProjectUsers(projectId, projectName) {
            // Verificar si el usuario tiene permisos para gestionar usuarios de este proyecto
            checkProjectAdminPermission(projectId)
                .then(hasPermission => {
                    if (!hasPermission) {
                        alert('No tienes permisos para gestionar usuarios de este proyecto.');
                        return;
                    }

                    currentProjectId = projectId;
                    document.getElementById('modal-title').textContent = `Gestionar Usuarios - ${projectName}`;
                    loadProjectUsers(projectId);
                    document.getElementById('users-modal').classList.add('show');
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos.');
                });
        }

        function toggleDebugInfo() {
            const debugElements = document.querySelectorAll('.debug-info');
            debugElements.forEach(el => {
                el.style.display = el.style.display === 'none' ? 'block' : 'none';
            });
        }

        function cleanAllProjectUsers() {
            if (!currentUser || currentUser.email !== 'admin@gnce.com') {
                alert('Solo los administradores pueden limpiar datos de proyectos.');
                return;
            }

            if (confirm('¿Limpiar y normalizar datos de usuarios autorizados en TODOS los proyectos? Esto corregirá estructuras de datos inconsistentes.')) {
                console.log('Iniciando limpieza de datos de usuarios en todos los proyectos...');
                
                db.collection('projects').get()
                    .then(querySnapshot => {
                        const updatePromises = [];
                        
                        querySnapshot.forEach(doc => {
                            const projectData = doc.data();
                            const authorizedUsers = projectData.authorizedUsers || [];
                            
                            console.log(`Verificando proyecto: ${projectData.projectName} (${doc.id})`);
                            console.log('authorizedUsers actuales:', authorizedUsers);
                            
                            // Normalizar la estructura de authorizedUsers
                            const normalizedUsers = authorizedUsers.map(user => {
                                if (typeof user === 'string') {
                                    // Convertir string a objeto
                                    return {
                                        uid: null,
                                        email: user,
                                        role: 'usuario',
                                        addedBy: 'admin@gnce.com',
                                        addedAt: new Date()
                                    };
                                } else if (typeof user === 'object' && user !== null) {
                                    // Asegurar que tenga todas las propiedades necesarias
                                    return {
                                        uid: user.uid || null,
                                        email: user.email || user.correo || user.usuario,
                                        role: user.role || user.rol || 'usuario',
                                        addedBy: user.addedBy || 'admin@gnce.com',
                                        addedAt: user.addedAt || new Date()
                                    };
                                }
                                return null;
                            }).filter(user => user !== null);
                            
                            console.log('authorizedUsers normalizados:', normalizedUsers);
                            
                            // Actualizar el proyecto
                            updatePromises.push(
                                db.collection('projects').doc(doc.id).update({
                                    authorizedUsers: normalizedUsers,
                                    lastUpdated: firebase.firestore.Timestamp.now()
                                })
                            );
                        });
                        
                        return Promise.all(updatePromises);
                    })
                    .then(() => {
                        console.log('Limpieza completada exitosamente');
                        showSuccess('Limpieza de datos completada exitosamente en todos los proyectos');
                        loadProjects(); // Recargar la lista
                    })
                    .catch(error => {
                        console.error('Error al limpiar datos:', error);
                        alert('Error al limpiar datos de proyectos.');
                    });
            }
        }

        function cleanUserData(projectId) {
            // Verificar permisos antes de limpiar datos
            checkProjectAdminPermission(projectId)
                .then(hasPermission => {
                    if (!hasPermission) {
                        alert('No tienes permisos para gestionar usuarios de este proyecto.');
                        return;
                    }

                    if (confirm('¿Limpiar y reparar datos de usuarios? Esto eliminará usuarios con datos inválidos y normalizará la estructura de datos.')) {
                        db.collection('projects').doc(projectId).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const projectData = doc.data();
                                    const authorizedUsers = projectData.authorizedUsers || [];

                                    console.log('Verificando integridad de usuarios...');

                                    // Filtrar solo usuarios válidos y normalizar estructura
                                    const cleanUsers = authorizedUsers.filter((user, index) => {
                                        if (!user || typeof user !== 'object') {
                                            console.log('Eliminando usuario inválido:', index, user);
                                            return false;
                                        }

                                        const hasEmail = user.email || user.correo || user.usuario;
                                        if (!hasEmail) {
                                            console.log('Eliminando usuario sin email:', index, user);
                                            return false;
                                        }

                                        return true;
                                    }).map(user => {
                                        // Normalizar la estructura
                                        const normalizedUser = {
                                            uid: user.uid || null,
                                            email: user.email || user.correo || user.usuario,
                                            role: user.role || user.rol || 'usuario',
                                            addedBy: user.addedBy || currentUser.email,
                                            addedAt: user.addedAt || new Date()
                                        };

                                        // Remover propiedades antiguas
                                        delete normalizedUser.correo;
                                        delete normalizedUser.usuario;
                                        delete normalizedUser.rol;

                                        return normalizedUser;
                                    });

                                    console.log('Usuarios después de limpieza:', cleanUsers);

                                    db.collection('projects').doc(projectId).update({
                                        authorizedUsers: cleanUsers,
                                        lastUpdated: firebase.firestore.Timestamp.now()
                                    })
                                    .then(() => {
                                        console.log('Limpieza completada exitosamente');
                                        showSuccess('Limpieza de datos completada exitosamente');
                                        loadProjectUsers(projectId);
                                    })
                                    .catch(error => {
                                        console.error('Error al limpiar datos:', error);
                                        alert('Error al limpiar datos de usuarios.');
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error al obtener proyecto:', error);
                                alert('Error al obtener información del proyecto.');
                            });
                    }
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos.');
                });
        }

        function loadProjectUsers(projectId) {
            // Verificar permisos de admin para este proyecto
            checkProjectAdminPermission(projectId)
                .then(hasAdminPermission => {
                    const usersList = document.getElementById('users-list');
                    usersList.innerHTML = '<p>Cargando usuarios...</p>';

                    // Mostrar/ocultar controles de admin según permisos
                    const modalActions = document.querySelector('.modal-actions');
                    const addUserForm = document.querySelector('.add-user-form');
                    
                    if (hasAdminPermission) {
                        modalActions.style.display = 'flex';
                        addUserForm.style.display = 'block';
                    } else {
                        modalActions.style.display = 'none';
                        addUserForm.style.display = 'none';
                    }

                    db.collection('projects').doc(projectId).get()
                        .then(doc => {
                            if (doc.exists) {
                                const projectData = doc.data();
                                const authorizedUsers = projectData.authorizedUsers || [];

                                console.log('Usuarios autorizados para el proyecto:', authorizedUsers);
                                console.log('Datos completos del proyecto:', projectData);

                                if (authorizedUsers.length === 0) {
                                    usersList.innerHTML = '<p>No hay usuarios autorizados para este proyecto.</p>';
                                    return;
                                }

                                usersList.innerHTML = '';

                                // Agregar información de debug
                                const debugInfo = document.createElement('div');
                                debugInfo.className = 'debug-info';
                                debugInfo.style.cssText = 'background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 0.8em; color: #666; display: none;';
                                debugInfo.innerHTML = `<strong>Debug:</strong> ${authorizedUsers.length} usuario(s) encontrado(s) en la base de datos.`;
                                usersList.appendChild(debugInfo);

                                authorizedUsers.forEach((user, index) => {
                                    console.log('Procesando usuario:', index, user);

                                    // Validar que el usuario tenga los datos necesarios
                                    if (!user || typeof user !== 'object') {
                                        console.warn('Usuario inválido encontrado:', user);
                                        const errorItem = document.createElement('div');
                                        errorItem.className = 'user-item';
                                        errorItem.innerHTML = `
                                            <div class="user-info">
                                                <div class="user-email" style="color: #e74c3c;">Usuario con datos inválidos</div>
                                                <div class="user-role">Índice: ${index}</div>
                                            </div>
                                            <div class="user-actions">
                                                ${hasAdminPermission ? `<button class="user-action-btn delete" onclick="removeUser('${projectId}', ${index}, 'usuario-invalido')">
                                                    <i class="fas fa-trash"></i> Eliminar
                                                </button>` : ''}
                                            </div>
                                        `;
                                        usersList.appendChild(errorItem);
                                        return;
                                    }

                                    const userEmail = user.email || user.correo || user.usuario || `Usuario ${index + 1}`;
                                    const userRole = user.role || user.rol || 'usuario';
                                    const userUid = user.uid || 'N/A';

                                    console.log(`Usuario ${index}: email=${userEmail}, role=${userRole}, uid=${userUid}`);

                                    const userItem = document.createElement('div');
                                    userItem.className = `user-item ${userRole === 'administrador' || userRole === 'admin' ? 'admin' : ''}`;

                                    userItem.innerHTML = `
                                        <div class="user-info">
                                            <div class="user-email">${userEmail}</div>
                                            <div class="user-role">${userRole === 'administrador' || userRole === 'admin' ? 'Administrador' : 'Usuario Estándar'}</div>
                                        </div>
                                        <div class="user-actions">
                                            ${hasAdminPermission ? `
                                                <button class="user-action-btn edit" onclick="editUserRole('${projectId}', ${index}, '${userEmail}', '${userRole}')">
                                                    <i class="fas fa-edit"></i> Editar
                                                </button>
                                                <button class="user-action-btn delete" onclick="removeUser('${projectId}', ${index}, '${userEmail}')">
                                                    <i class="fas fa-trash"></i> Eliminar
                                                </button>
                                            ` : ''}
                                        </div>
                                    `;

                                    usersList.appendChild(userItem);
                                });
                            } else {
                                console.warn('Proyecto no encontrado:', projectId);
                                usersList.innerHTML = '<p>Proyecto no encontrado.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error al cargar usuarios:', error);
                            usersList.innerHTML = '<p>Error al cargar usuarios.</p>';
                        });
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos para cargar usuarios.');
                });
        }

        function addUserToProject(projectId) {
            // Verificar permisos antes de agregar usuario
            checkProjectAdminPermission(projectId)
                .then(hasPermission => {
                    if (!hasPermission) {
                        alert('No tienes permisos para gestionar usuarios de este proyecto.');
                        return;
                    }

                    const email = document.getElementById('new-user-email').value.trim();
                    const password = document.getElementById('new-user-password').value;
                    const role = document.getElementById('new-user-role').value;

                    if (!email || !role) {
                        alert('Por favor, completa todos los campos.');
                        return;
                    }

                    // Validar formato de email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        alert('Por favor, ingresa un correo electrónico válido.');
                        return;
                    }

                    // Mostrar indicador de carga
                    const addBtn = document.getElementById('add-user-btn');
                    const originalText = addBtn.textContent;
                    addBtn.textContent = 'Procesando...';
                    addBtn.disabled = true;

                    console.log('Verificando usuario:', email);

                    // Guardar credenciales del usuario admin actual para restaurar sesión después
                    const adminEmail = currentUser.email;
                    const adminUid = currentUser.uid;

                    // Primero verificar si el usuario ya existe en el proyecto
                    db.collection('projects').doc(projectId).get()
                        .then(doc => {
                            if (doc.exists) {
                                const projectData = doc.data();
                                const authorizedUsers = projectData.authorizedUsers || [];

                                const userExists = authorizedUsers.some(user => {
                                    // Manejar diferentes formatos de usuario
                                    if (typeof user === 'string') {
                                        return user.toLowerCase() === email.toLowerCase();
                                    } else if (typeof user === 'object' && user !== null) {
                                        const userEmail = user.email || user.correo || user.usuario;
                                        return userEmail && userEmail.toLowerCase() === email.toLowerCase();
                                    }
                                    return false;
                                });
                                if (userExists) {
                                    throw new Error('Este usuario ya está autorizado para el proyecto.');
                                }

                                // Intentar crear el usuario en Firebase Auth
                                // Si ya existe, el error será capturado y manejado
                                const createUserPromise = password && password.length >= 6
                                    ? auth.createUserWithEmailAndPassword(email, password)
                                    : Promise.reject(new Error('auth/requires-password'));

                                return createUserPromise
                                    .then((userCredential) => {
                                        console.log('Usuario creado en Firebase Auth:', userCredential.user.uid);

                                        authorizedUsers.push({
                                            uid: userCredential.user.uid,
                                            email: email,
                                            role: role,
                                            addedBy: adminEmail,
                                            addedAt: new Date()
                                        });

                                        return db.collection('projects').doc(projectId).update({
                                            authorizedUsers: authorizedUsers,
                                            lastUpdated: firebase.firestore.Timestamp.now()
                                        })
                                        .then(() => {
                                            // Después de agregar al proyecto, necesitamos restaurar la sesión del admin
                                            console.log('Usuario agregado al proyecto, restaurando sesión del admin...');
                                            // Como acabamos de crear el usuario, estamos logueados con él
                                            // Necesitamos volver a loguear al admin, pero no tenemos su contraseña
                                            // Por ahora, solo mostraremos una advertencia
                                            console.warn('Sesión cambiada al nuevo usuario. El admin debe refrescar la página.');
                                            return userCredential;
                                        });
                                    })
                                    .catch((createError) => {
                                        console.log('Error al crear usuario:', createError.code, createError.message);

                                        // Si el usuario ya existe en Firebase Auth
                                        if (createError.code === 'auth/email-already-in-use') {
                                            console.log('Usuario ya existe en Firebase Auth, autorizando para el proyecto...');

                                            // Agregar usuario al proyecto sin UID (se actualizará cuando inicie sesión)
                                            authorizedUsers.push({
                                                uid: null, // Se actualizará cuando el usuario inicie sesión
                                                email: email,
                                                role: role,
                                                addedBy: adminEmail,
                                                addedAt: new Date()
                                            });

                                            return db.collection('projects').doc(projectId).update({
                                                authorizedUsers: authorizedUsers,
                                                lastUpdated: firebase.firestore.Timestamp.now()
                                            });
                                        } else if (createError.message === 'auth/requires-password') {
                                            // No se proporcionó contraseña para usuario nuevo
                                            throw new Error('La contraseña debe tener al menos 6 caracteres para crear un nuevo usuario.');
                                        } else {
                                            // Otro error al crear usuario
                                            throw createError;
                                        }
                                    });
                            } else {
                                throw new Error('Proyecto no encontrado.');
                            }
                        })
                        .then((result) => {
                            console.log('Usuario autorizado para el proyecto exitosamente');
                            
                            // Verificar si la sesión cambió (si result es un userCredential, significa que se creó un usuario)
                            if (result && result.user && result.user.email !== adminEmail) {
                                // La sesión cambió al nuevo usuario
                                console.warn('Sesión cambiada al nuevo usuario. Necesitamos restaurar la sesión del admin.');
                                
                                // Mostrar mensaje especial para el admin
                                const sessionWarning = document.createElement('div');
                                sessionWarning.id = 'session-warning';
                                sessionWarning.style.cssText = `
                                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                    background: rgba(255, 255, 255, 0.95); color: #2c3e50; 
                                    padding: 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                                    text-align: center; z-index: 9999; max-width: 400px;
                                `;
                                sessionWarning.innerHTML = `
                                    <h3 style="margin-top: 0; color: #e74c3c;">Sesión Cambiada</h3>
                                    <p>Se creó un nuevo usuario y la sesión cambió automáticamente.</p>
                                    <p>Para continuar como administrador, debe refrescar la página.</p>
                                    <button onclick="location.reload()" style="
                                        background: #3498db; color: white; border: none; padding: 10px 20px;
                                        border-radius: 5px; cursor: pointer; margin-top: 15px;
                                    ">Refrescar Página</button>
                                `;
                                document.body.appendChild(sessionWarning);
                                
                                showSuccess('Usuario creado exitosamente. Refresca la página para continuar como administrador.');
                            } else {
                                showSuccess('Usuario autorizado para el proyecto exitosamente');
                            }

                            // Limpiar formulario
                            document.getElementById('new-user-email').value = '';
                            document.getElementById('new-user-password').value = '';
                            document.getElementById('new-user-role').value = '';

                            // Recargar lista de usuarios
                            loadProjectUsers(projectId);
                        })
                        .catch(error => {
                            console.error('Error al autorizar usuario:', error);

                            let errorMessage = 'Error al autorizar usuario. ';
                            if (error.message === 'Este usuario ya está autorizado para el proyecto.') {
                                errorMessage = error.message;
                            } else if (error.code === 'auth/weak-password') {
                                errorMessage += 'La contraseña es demasiado débil.';
                            } else if (error.code === 'auth/invalid-email') {
                                errorMessage += 'El correo electrónico no es válido.';
                            } else if (error.message === 'La contraseña debe tener al menos 6 caracteres para crear un nuevo usuario.') {
                                errorMessage = error.message;
                            } else if (error.message) {
                                errorMessage += error.message;
                            } else {
                                errorMessage += 'Inténtalo de nuevo.';
                            }

                            alert(errorMessage);
                        })
                        .finally(() => {
                            // Restaurar botón
                            addBtn.textContent = originalText;
                            addBtn.disabled = false;
                        });
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos.');
                });
        }

        function editUserRole(projectId, userIndex, userEmail, currentRole) {
            // Verificar permisos antes de editar rol
            checkProjectAdminPermission(projectId)
                .then(hasPermission => {
                    if (!hasPermission) {
                        alert('No tienes permisos para gestionar usuarios de este proyecto.');
                        return;
                    }

                    console.log('Editando usuario:', { projectId, userIndex, userEmail, currentRole });

                    const newRole = (currentRole === 'administrador' || currentRole === 'admin') ? 'usuario' : 'administrador';
                    const newRoleDisplay = newRole === 'administrador' ? 'Administrador' : 'Usuario Estándar';

                    if (confirm(`¿Cambiar el rol de "${userEmail}" a ${newRoleDisplay}?`)) {
                        db.collection('projects').doc(projectId).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const projectData = doc.data();
                                    const authorizedUsers = projectData.authorizedUsers || [];

                                    console.log('Usuarios antes de editar:', authorizedUsers);

                                    if (authorizedUsers[userIndex]) {
                                        // Actualizar el rol
                                        authorizedUsers[userIndex].role = newRole;

                                        // Asegurarse de que tenga la estructura correcta
                                        if (!authorizedUsers[userIndex].email) {
                                            authorizedUsers[userIndex].email = userEmail;
                                        }

                                        console.log('Usuarios después de editar:', authorizedUsers);

                                        db.collection('projects').doc(projectId).update({
                                            authorizedUsers: authorizedUsers,
                                            lastUpdated: firebase.firestore.Timestamp.now()
                                        })
                                        .then(() => {
                                            console.log('Rol de usuario actualizado');
                                            showSuccess('Rol de usuario actualizado exitosamente');
                                            loadProjectUsers(projectId);
                                        })
                                        .catch(error => {
                                            console.error('Error al actualizar rol:', error);
                                            alert('Error al actualizar el rol del usuario.');
                                        });
                                    } else {
                                        console.error('Usuario no encontrado en el índice:', userIndex);
                                        alert('Usuario no encontrado.');
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error al obtener proyecto:', error);
                                alert('Error al obtener información del proyecto.');
                            });
                    }
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos.');
                });
        }

        function removeUser(projectId, userIndex, userEmail) {
            // Verificar permisos antes de eliminar usuario
            checkProjectAdminPermission(projectId)
                .then(hasPermission => {
                    if (!hasPermission) {
                        alert('No tienes permisos para gestionar usuarios de este proyecto.');
                        return;
                    }

                    console.log('Eliminando usuario del proyecto:', { projectId, userIndex, userEmail });

                    if (confirm(`¿Estás seguro de que quieres eliminar a "${userEmail}" de este proyecto?\n\nNota: El usuario podrá seguir accediendo a otros proyectos donde esté autorizado.`)) {
                        db.collection('projects').doc(projectId).get()
                            .then(doc => {
                                if (doc.exists) {
                                    const projectData = doc.data();
                                    const authorizedUsers = projectData.authorizedUsers || [];

                                    console.log('Usuarios antes de eliminar:', authorizedUsers);

                                    if (userIndex >= 0 && userIndex < authorizedUsers.length) {
                                        const userToRemove = authorizedUsers[userIndex];
                                        console.log('Usuario a eliminar:', userToRemove);

                                        // Remover usuario del array
                                        authorizedUsers.splice(userIndex, 1);

                                        console.log('Usuarios después de eliminar:', authorizedUsers);

                                        db.collection('projects').doc(projectId).update({
                                            authorizedUsers: authorizedUsers,
                                            lastUpdated: firebase.firestore.Timestamp.now()
                                        })
                                        .then(() => {
                                            console.log('Usuario eliminado del proyecto exitosamente');
                                            showSuccess('Usuario eliminado del proyecto exitosamente');

                                            // Si el usuario no está autorizado en ningún otro proyecto, podríamos eliminarlo de Auth
                                            // Pero por ahora solo lo removemos del proyecto actual
                                            loadProjectUsers(projectId);
                                        })
                                        .catch(error => {
                                            console.error('Error al eliminar usuario del proyecto:', error);
                                            alert('Error al eliminar usuario del proyecto.');
                                        });
                                    } else {
                                        console.error('Índice de usuario inválido:', userIndex);
                                        alert('Usuario no encontrado.');
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error al obtener proyecto:', error);
                                alert('Error al obtener información del proyecto.');
                            });
                    }
                })
                .catch(error => {
                    console.error('Error al verificar permisos:', error);
                    alert('Error al verificar permisos.');
                });
        }

        function closeUsersModal() {
            document.getElementById('users-modal').classList.remove('show');
            currentProjectId = null;

            // Limpiar formulario
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-role').value = '';
        }

        // Event listener para el botón de cerrar sesión
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres cerrar la sesión?')) {
                auth.signOut()
                    .then(() => {
                        console.log('Sesión cerrada exitosamente');
                        window.location.href = 'login.html';
                    })
                    .catch(error => {
                        console.error('Error al cerrar sesión:', error);
                        alert('Error al cerrar la sesión. Inténtalo de nuevo.');
                    });
            }
        });

        // Event listeners para el modal de usuarios
        document.getElementById('close-users-modal').addEventListener('click', closeUsersModal);
        document.getElementById('cancel-add-user').addEventListener('click', closeUsersModal);
        document.getElementById('add-user-btn').addEventListener('click', () => {
            if (currentProjectId) {
                addUserToProject(currentProjectId);
            }
        });

        // Cerrar modal al hacer clic fuera del contenido
        document.getElementById('users-modal').addEventListener('click', (e) => {
            if (e.target.id === 'users-modal') {
                closeUsersModal();
            }
        });
    </script>
</body>
</html>
