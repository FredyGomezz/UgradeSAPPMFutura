<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista de Proyecto - PDT Futura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="vistaProyecto.css">
    <style>
        /**
         * Ajuste para alinear las etiquetas de las m√©tricas en la parte inferior de sus tarjetas.
         * Esto mejora la consistencia visual de la secci√≥n de la Curva S.
         */
        .s-curve-metrics .metric-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container" id="project-container">
        <!-- Logo de la compa√±√≠a al inicio -->
        <div class="company-logo-top">
            <img src="logo_2025web.png" alt="Company Logo">

        <div class="header">
            <h1 id="project-name">Cargando proyecto...</h1>
            <p>Cronograma de Proyecto - L√≠nea de Tiempo Interactiva</p>
            <div class="progress-summary">
                <div class="progress-text">Progreso General del Proyecto</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="overall-progress"><span id="progress-text">0%</span></div>
                </div>
                <div class="progress-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="total-tasks">0</span>
                        <span>Total de Tareas</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="total-hours">0</span>
                        <span>Total de Horas</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="completed-tasks">0</span>
                        <span>Tareas Completadas</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="completed-hours">0</span>
                        <span>Horas Completadas</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="timeline-container">
            <div class="project-dates-interactive" id="informacionProyecto">
                <div class="config-header">
                    <h3>Datos generales del Proyecto</h3>
                    <button id="toggle-config-btn" class="toggle-config-btn" aria-label="Contraer o expandir configuraci√≥n">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div class="project-config collapsed" id="project-config-content">
                    <!-- Configuraci√≥n de Fechas -->
                    <div class="config-group">
                        <h4 class="config-group-title">üìÖ Configuraci√≥n de Fechas</h4>
                        <div class="config-row">
                            <div class="config-item">
                                <label for="start-date-input">Fecha de Inicio:</label>
                                <input type="date" id="start-date-input">
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n de D√≠as Laborables -->
                    <div class="config-group">
                        <h4 class="config-group-title">üìÜ D√≠as Laborables</h4>
                        <div class="config-row">
                            <div class="config-item">
                                <label for="include-saturdays">Excluir S√°bados:</label>
                                <input type="checkbox" id="include-saturdays">
                            </div>
                            <div class="config-item">
                                <label for="include-sundays">Excluir Domingos:</label>
                                <input type="checkbox" id="include-sundays">
                            </div>
                            <div class="config-item">
                                <label for="include-holidays">Excluir Festivos del calendario laboral:</label>
                                <input type="checkbox" id="include-holidays">
                            </div>
                        </div>
                        <div class="holidays-list" id="holidays-list" style="display: none;">
                            <h4>Festivos Seleccionados:</h4>
                            <div id="holidays-container"></div>
                            <button type="button" id="add-holiday-btn">Agregar Festivo</button>
                        </div>
                    </div>

                    <!-- Configuraci√≥n de Horarios -->
                    <div class="config-group">
                        <h4 class="config-group-title">‚è∞ Horarios de Trabajo</h4>
                        <div class="config-row">
                            <div class="config-item">
                                <label for="shift-start-time">Hora Inicio Turno:</label>
                                <input type="time" id="shift-start-time" value="08:00">
                            </div>
                            <div class="config-item">
                                <label for="shift-end-time">Hora Fin Turno:</label>
                                <input type="time" id="shift-end-time" value="17:00">
                            </div>
                        </div>
                        <div class="config-row">
                            <div class="config-item">
                                <label for="shift-break-start-time">Inicio Descanso:</label>
                                <input type="time" id="shift-break-start-time" value="12:00">
                            </div>
                            <div class="config-item">
                                <label for="shift-break-hours">Horas Descanso Turno:</label>
                                <input type="number" id="shift-break-hours" min="0" max="8" step="0.5" value="1">
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="config-group">
                        <div class="config-buttons">
                            <button id="recalculate-dates-btn">Aplicar Cambios</button>
                        </div>
                    </div>
                </div>
                <div class="date-info">
                    <p><strong>Inicio:</strong> <span id="project-start-date">--</span></p>
                    <p><strong>Fin Estimado:</strong> <span id="project-end-date">--</span></p>
                    <p><strong>Duraci√≥n:</strong> <span id="project-duration">--</span> d√≠as</p>
                    <p><strong>√öltima Actualizaci√≥n:</strong> <span id="project-last-update">--</span></p>
                </div>
            </div>
            <div id="phases-container" class="phases-container">
                <!-- Las fases y tareas se cargar√°n aqu√≠ -->
            </div>
            
            <!-- Leyenda de tareas -->
            <div class="tasks-legend">
                <h3>Leyenda de Tareas</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f8f9fa; border-left: 4px solid #bdc3c7;"></div>
                        <span>Tarea Regular</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color milestone" style="background: linear-gradient(135deg, #fff5f5, #ffeaea); border-left: 4px solid #e74c3c;"></div>
                        <span>Hito üéØ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color completed" style="background: #d4edda; border-left: 4px solid #28a745;"></div>
                        <span>Tarea Completada ‚úÖ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol">
                            <span class="task-hours-example">8h</span>
                        </div>
                        <span>Horas de la tarea</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol">
                            <span class="task-dates-example">01/01 - 05/01</span>
                        </div>
                        <span>Fechas de inicio y fin</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol">
                            <span style="font-size: 0.7rem; color: #2c3e50;">08:00 - 17:00</span>
                        </div>
                        <span>Horas espec√≠ficas de tareas</span>
                    </div>
                </div>
            </div>
            
            <div class="calendar-section" id="calendarioProyecto">
                <div class="section-header">
                    <h2>Calendario del Proyecto</h2>
                    <button id="toggle-calendar-btn" class="toggle-section-btn" aria-label="Contraer o expandir calendario">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div id="calendar-content-wrapper" class="collapsed"><div id="calendar-container"></div></div>
            </div>

            <!-- Modal de tareas del d√≠a -->
            <div id="day-tasks-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-date-title">Tareas del d√≠a</h3>
                        <button id="close-modal-btn" class="close-modal-btn">&times;</button>
                    </div>
                    <div id="modal-tasks-list" class="modal-tasks-list">
                        <!-- Las tareas se cargar√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
            </div>

            <div class="s-curve-section" id="curvaSProyecto">
                <h2>Seguimiento visual del Proyecto</h2>
                <div id="s-curve-content"> <!-- Contenedor agregado -->
                    <canvas id="s-curve-chart"></canvas>
                    <div class="s-curve-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="schedule-variance">--</div>
                            <div class="metric-label">Variaci√≥n de Cronograma</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="performance-index">--</div>
                            <div class="metric-label">√çndice de Rendimiento</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="project-status">--</div>
                            <div class="metric-label">Estado del Proyecto</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="gantt-section" id="ganttProyecto">
                <h2>Diagrama de Gantt - Cronograma de Tareas</h2>
                <div id="gantt-chart-container"></div>
            </div>

            <div style="text-align: center; margin: 20px 0;" id="project-actions">
                <button id="download-pdf-btn">Descargar PDF</button>
                <button id="back-to-projects-btn">Volver a Proyectos</button>
                <button id="logout-btn">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

    <!-- Contenedor oculto para la generaci√≥n de la Curva S para el PDF -->
    <div id="pdf-s-curve-generator" style="position: absolute; left: -9999px; top: -9999px; width: 1200px; height: 600px;">
        <canvas id="pdf-s-curve-canvas"></canvas>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Librer√≠as para Generaci√≥n de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Puente de compatibilidad para jspdf-autotable v3 con jspdf v2.
        // Se ejecuta ANTES de que se cargue el plugin.
        window.jsPDF = window.jspdf.jsPDF;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!--  A√±ade estas dos l√≠neas ANTES de cargar pdf-generator.js y vistaProyecto.js
    Esto asegura que las clases ReportDataBuilder y PDFDrawer est√©n disponibles
    cuando el generador de PDF las necesite.
    -->
    <script src="project-utils.js"></script>
    <script src="report-data-builder.js"></script>
    <script src="pdf-drawer.js"></script>


    <!-- L√≥gica de generaci√≥n de PDF refactorizada -->
    <script src="pdf-generator.js"></script>

    <!-- Bot√≥n flotante de navegaci√≥n -->
    <div id="floatingNavBtn">
                    <img src="IconoGNCE.png" alt="Men√∫ de navegaci√≥n" style="width: 24px; height: 24px;">        <div id="floatingNavMenu">
            <a href="#informacionProyecto">Informaci√≥n</a>
            <a href="#phases-container">Fases</a>
            <a href="#calendarioProyecto">Calendario</a>
            <a href="#curvaSProyecto">Curva S</a>
            <a href="#ganttProyecto">Gantt</a>
            <a href="#project-actions">Finalizar</a>
        </div>
    </div>

    <script>
        /**
         * Este script unifica la l√≥gica de las m√©tricas de la Curva S en la vista del proyecto.
         * Utiliza ReportDataBuilder como la √∫nica fuente de verdad para los c√°lculos,
         * asegurando que las m√©tricas mostradas en la p√°gina sean id√©nticas a las del PDF.
         */

        function initializeApp(firebaseApp) {
            // Definimos auth y db para que est√©n disponibles en el √°mbito de esta funci√≥n
            const auth = firebaseApp.auth();
            const db = firebaseApp.firestore();

            // Inicializamos el servicio de notificaciones con la instancia de db
            const notificationService = initializeNotificationService(db);
            
            // Ahora que db y auth est√°n definidos, cargamos el script principal de la p√°gina.
            const projectScript = document.createElement('script');
            projectScript.src = 'vistaProyecto.js';
            projectScript.onload = () => {
                // Una vez cargado, inicializamos la l√≥gica de la p√°gina
                window.initializeProjectView(db, auth, notificationService);
            };
            document.body.appendChild(projectScript);

            // La exponemos globalmente para que sea accesible desde vistaProyecto.js
            window.updateSCurveMetrics = (projectData) => {
                if (!projectData || typeof ReportDataBuilder === 'undefined') {
                    console.error("ReportDataBuilder no est√° disponible o no hay datos del proyecto.");
                    return;
                }

                const reportBuilder = new ReportDataBuilder(projectData);
                const metrics = reportBuilder.getAdvancedMetrics();

                document.getElementById('schedule-variance').textContent = metrics.scheduleVariance || '--';
                document.getElementById('performance-index').textContent = metrics.performanceIndex || '--';
                document.getElementById('project-status').textContent = metrics.projectStatus || '--';
            };
        }

        // Carga din√°mica de firebase-init.js y ejecuci√≥n del callback
        // Primero cargamos el servicio de notificaciones que es una dependencia
        const notificationScript = document.createElement('script');
        notificationScript.src = 'notification-service.js?v=1.2';
        notificationScript.onload = () => {
            const firebaseScript = document.createElement('script');
            firebaseScript.src = 'firebase-init.js';
            firebaseScript.onload = () => initializeFirebaseApp(initializeApp);
            document.head.appendChild(firebaseScript);
        };
        document.head.appendChild(notificationScript);
    </script>
</body>
</html>
