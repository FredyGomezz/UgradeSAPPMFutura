<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar Proyecto - PDT Futura</title>
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: radial-gradient(ellipse at center, #0f0f23 0%, #000000 100%);
            color: white;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; }
        .form-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer;
            background-color: #2575fc; color: white; font-weight: bold;
        }
        input[type="text"], input[type="file"], input[type="date"] {
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc;
            background-color: #333; color: white;
        }
        .checkbox-group label { margin-right: 15px; }

        /* Logo en el footer */
        .footer-logo {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50%;
            max-width: 150px;
            z-index: 10;
            text-align: center;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .footer-logo img {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5));
            transition: all 0.3s ease;
        }

        /* Efecto de reflejo cuando la luz pasa sobre el logo */
        .footer-logo.reflected img {
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8))
                    brightness(1.2);
        }

        /* Animaci√≥n de progreso mejorada */
        #loading-spinner {
            display: none;
            text-align: center;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
        }

        #creation-progress {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            background: #333;
            overflow: hidden;
        }

        #creation-progress::-webkit-progress-bar {
            background: #333;
        }

        #creation-progress::-webkit-progress-value {
            background: linear-gradient(90deg, #2575fc, #6a11cb);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        #creation-progress::-moz-progress-bar {
            background: linear-gradient(90deg, #2575fc, #6a11cb);
            border-radius: 10px;
        }

        #progress-status {
            margin-top: 10px;
            font-weight: bold;
            color: #87cefa;
        }
    </style>
</head>
<body>
    <div class="container" id="main-content" style="display: none;">
        <h1>Generar Nuevo Proyecto</h1>

        <div class="form-section">
            <h2>1. Generar Plantilla</h2>
            <p>Descargue la plantilla Excel organizada para llenar los datos del proyecto.</p>
            <button id="generate-template" class="btn">Generar Plantilla Excel</button>
        </div>

        <div class="form-section">
            <h2>2. Configurar Proyecto</h2>
            <label for="project-name">Nombre del Proyecto:</label>
            <input type="text" id="project-name" placeholder="Ingrese el nombre del proyecto" required>
            
            <label for="project-description">Descripci√≥n del Proyecto:</label>
            <textarea id="project-description" placeholder="Ingrese la descripci√≥n del proyecto" rows="3" style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #333; color: white;"></textarea>

            <label for="project-start-date">Fecha de Inicio del Proyecto:</label>
            <input type="date" id="project-start-date" required>
        </div>

        <div class="form-section">
            <h2>3. Cargar Archivo del Proyecto</h2>
            <p>Seleccione el archivo CSV/Excel con los datos del proyecto.</p>
            <input type="file" id="project-file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" required>
            <button id="load-project" class="btn">Cargar y Crear Proyecto</button>
            <div id="loading-spinner">
                <p>Creando proyecto...</p>
                <progress id="creation-progress" value="0" max="100"></progress>
                <p id="progress-status"></p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Configuraci√≥n centralizada de Firebase -->
    <script src="config/firebase.js"></script>

    <script>
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(user => {
            if (user && user.email === 'admin@gnce.com') {
                document.getElementById('main-content').style.display = 'block';
            } else {
                alert('Acceso denegado. Solo los administradores pueden acceder a esta p√°gina.');
                window.location.href = 'proyectos.html';
            }
        });

        document.getElementById('generate-template').addEventListener('click', () => {
            // Crear un nuevo workbook
            const wb = XLSX.utils.book_new();
            
            // Crear la hoja de instrucciones
            const instructionsData = [
                ['INSTRUCCIONES PARA LLENAR LA PLANTILLA'],
                [''],
                ['Esta plantilla est√° organizada para facilitar la creaci√≥n de proyectos en PDT Futura.'],
                [''],
                ['üìã REGLAS IMPORTANTES:'],
                ['‚Ä¢ Las filas que empiezan con "Fase" definen fases del proyecto'],
                ['‚Ä¢ Las dem√°s filas son tareas dentro de la fase actual'],
                ['‚Ä¢ Duraci√≥n en horas (puede usar decimales: 2.5, 0.75, etc.)'],
                ['‚Ä¢ Coloque "x" en la columna Hito para marcar hitos importantes'],
                ['‚Ä¢ Deje filas vac√≠as entre fases para mejor organizaci√≥n'],
                ['‚Ä¢ Guarde el archivo como Excel (.xlsx) y c√°rguelo en la herramienta'],
                [''],
                ['üìä ESTRUCTURA DE COLUMNAS:'],
                ['‚Ä¢ Tarea: Nombre de la fase o tarea'],
                ['‚Ä¢ Duraci√≥n (Horas): Tiempo estimado en horas'],
                ['‚Ä¢ Hito: "x" si es un hito importante, vac√≠o si es tarea normal'],
                [''],
                ['üí° EJEMPLOS DE DURACIONES:'],
                ['‚Ä¢ 8 horas = 1 d√≠a laboral completo'],
                ['‚Ä¢ 4 horas = medio d√≠a'],
                ['‚Ä¢ 16 horas = 2 d√≠as laborales'],
                ['‚Ä¢ 2.5 horas = 2 horas y 30 minutos'],
                ['']
            ];
            
            const instructionsWS = XLSX.utils.aoa_to_sheet(instructionsData);
            
            // Crear la hoja de plantilla
            const templateData = [
                ['Tarea', 'Duraci√≥n (Horas)', 'Hito'],
                [''],
                ['Fase 1: An√°lisis y Planificaci√≥n', '', ''],
                ['Revisar requerimientos del cliente', 8, ''],
                ['Analizar viabilidad t√©cnica', 12, ''],
                ['Elaborar plan de proyecto detallado', 6, 'x'],
                [''],
                ['Fase 2: Desarrollo e Implementaci√≥n', '', ''],
                ['Implementar funcionalidad principal', 16, ''],
                ['Desarrollar interfaz de usuario', 10, ''],
                ['Realizar pruebas unitarias', 8, ''],
                ['Liberar versi√≥n beta', 4, 'x'],
                [''],
                ['Fase 3: Pruebas y Despliegue', '', ''],
                ['Ejecutar pruebas de integraci√≥n', 12, ''],
                ['Realizar pruebas de aceptaci√≥n con usuario', 8, ''],
                ['Preparar documentaci√≥n t√©cnica', 4, ''],
                ['Desplegar en producci√≥n', 2, 'x'],
                [''],
                ['Fase 4: Soporte y Mantenimiento', '', ''],
                ['Capacitaci√≥n al equipo de soporte', 4, ''],
                ['Monitoreo inicial del sistema', 8, ''],
                ['Entrega final del proyecto', 2, 'x']
            ];
            
            const templateWS = XLSX.utils.aoa_to_sheet(templateData);
            
            // Configurar anchos de columna para mejor visualizaci√≥n
            instructionsWS['!cols'] = [{ width: 60 }];
            templateWS['!cols'] = [
                { width: 40 }, // Columna Tarea
                { width: 18 }, // Columna Duraci√≥n
                { width: 8 }   // Columna Hito
            ];
            
            // Agregar las hojas al workbook
            XLSX.utils.book_append_sheet(wb, instructionsWS, 'Instrucciones');
            XLSX.utils.book_append_sheet(wb, templateWS, 'Plantilla Proyecto');
            
            // Generar el archivo Excel
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            
            // Crear enlace de descarga de forma m√°s compatible
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = "plantilla_proyecto_pdt_futura.xlsx";
            link.style.display = 'none';
            
            // Forzar la descarga
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Limpiar el URL object
            setTimeout(() => URL.revokeObjectURL(url), 100);
        });

        // --- Project Loading Logic ---
        document.getElementById('load-project').addEventListener('click', async () => {
            const projectName = document.getElementById('project-name').value;
            const projectDescription = document.getElementById('project-description').value;
            const startDateInput = document.getElementById('project-start-date').valueAsDate;
            const projectFile = document.getElementById('project-file').files[0];

            if (!projectName || !projectDescription || !startDateInput || !projectFile) {
                alert('Por favor, complete todos los campos: Nombre, Descripci√≥n, Fecha de Inicio y Archivo.');
                return;
            }
            
            const startDate = new Date(startDateInput.getFullYear(), startDateInput.getMonth(), startDateInput.getDate(), 9, 0, 0, 0);

            document.getElementById('loading-spinner').style.display = 'block';
            const progressBar = document.getElementById('creation-progress');
            const progressStatus = document.getElementById('progress-status');

            try {
                let json;
                
                const fileName = projectFile.name.toLowerCase();
                const isCSV = fileName.endsWith('.csv');
                
                if (isCSV) {
                    const arrayBuffer = await projectFile.arrayBuffer();
                    let text = new TextDecoder('utf-8').decode(arrayBuffer);
                    if (text.includes('ÔøΩ')) {
                        text = new TextDecoder('windows-1252').decode(arrayBuffer);
                    }
                    const workbook = XLSX.read(text, { type: 'string' });
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('plantilla proyecto'));
                    if (!sheetName) {
                        throw new Error("No se encontr√≥ la hoja 'Plantilla Proyecto' en el archivo Excel. Aseg√∫rese de usar la plantilla generada por la herramienta.");
                    }
                    const worksheet = workbook.Sheets[sheetName];
                    json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                } else {
                    const data = await projectFile.arrayBuffer();
                    const workbook = XLSX.read(data);
                    console.log('Hojas encontradas en el archivo:', workbook.SheetNames);
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('plantilla proyecto'));
                    if (!sheetName) {
                        throw new Error("No se encontr√≥ la hoja 'Plantilla Proyecto' en el archivo Excel. Aseg√∫rese de usar la plantilla generada por la herramienta.");
                    }
                    const worksheet = workbook.Sheets[sheetName];
                    json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                }

                const headerRow = json.find(row => row && row.some(cell => {
                    const cellStr = String(cell || '').toLowerCase().trim();
                    return cellStr === 'tarea';
                }));
                const headerIndex = headerRow ? json.indexOf(headerRow) : -1;

                if (headerIndex === -1) {
                    console.error('Filas analizadas:', json.slice(0, 10));
                    throw new Error("No se encontr√≥ la fila de encabezado con 'Tarea' en la hoja 'Plantilla Proyecto'. Verifique que est√© usando la plantilla correcta generada por la herramienta.");
                }

                const colIndices = {};
                headerRow.forEach((header, index) => {
                    const h = String(header || '').toLowerCase().trim();
                    if (h === 'tarea') colIndices.name = index;
                    if (h === 'duraci√≥n (horas)' || h === 'duracion (horas)') colIndices.durationHours = index;
                    if (h === 'hito') colIndices.isMilestone = index;
                });

                if (colIndices.name === undefined || colIndices.durationHours === undefined || colIndices.isMilestone === undefined) {
                    console.error('Encabezados encontrados:', headerRow);
                    console.error('√çndices detectados:', colIndices);
                    throw new Error(`Los encabezados deben ser exactamente: 'Tarea', 'Duraci√≥n (Horas)', 'Hito'. Encabezados encontrados: ${headerRow.join(', ')}`);
                }

                console.log('Columnas detectadas correctamente:', {
                    tarea: colIndices.name,
                    duracion: colIndices.durationHours,
                    hito: colIndices.isMilestone
                });

                const rowsToProcess = json.slice(headerIndex + 1).filter(row => row && row.length > 0 && row.some(cell => cell !== null && cell !== ''));
                
                progressBar.max = rowsToProcess.length;
                progressBar.value = 0;
                progressStatus.textContent = 'Procesando archivo...';

                const projectData = {
                    projectName: projectName,
                    description: projectDescription,
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date()),
                    startDate: firebase.firestore.Timestamp.fromDate(startDate),
                    phases: [],
                    settings: {
                        skipSaturday: true,
                        skipSunday: true,
                        holidays: []
                    }
                };

                projectData.holidays = projectData.settings.holidays;

                let currentPhase = null;
                let processedRows = 0;
                
                for (const row of rowsToProcess) {
                    const firstCell = String(row[0] || '').trim();
                    const isPhaseRow = firstCell.toLowerCase().startsWith('fase');

                    if (isPhaseRow) {
                        if (currentPhase) {
                            projectData.phases.push(currentPhase);
                        }
                        currentPhase = { name: firstCell, tasks: [] };
                    } else if (row[colIndices.name] && String(row[colIndices.name]).trim() !== '') {
                        if (!currentPhase) {
                            currentPhase = { name: 'General', tasks: [] };
                        }
                        const rawDuration = row[colIndices.durationHours];
                        const parsedDuration = Number(String(rawDuration).replace(',', '.'));
                        const task = {
                            name: row[colIndices.name] || '',
                            durationHours: isFinite(parsedDuration) && parsedDuration >= 0 ? parsedDuration : 0,
                            isMilestone: (String(row[colIndices.isMilestone] || '').toLowerCase() === 'x')
                        };
                        currentPhase.tasks.push(task);
                    }
                    
                    processedRows++;
                    progressBar.value = processedRows;
                    progressStatus.textContent = `Procesando fila ${processedRows} de ${rowsToProcess.length}...`;
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                
                if (currentPhase) {
                    projectData.phases.push(currentPhase);
                }

                progressStatus.textContent = 'Calculando fechas...';
                calculateAllTaskDates(projectData);

                progressStatus.textContent = 'Guardando proyecto...';
                console.log("Datos que se enviar√°n a Firestore:", JSON.stringify(projectData, null, 2));

                const d = new Date();
                const projectId = `${String(d.getDate()).padStart(2, '0')}${String(d.getMonth() + 1).padStart(2, '0')}${d.getFullYear()}${String(d.getHours()).padStart(2, '0')}${String(d.getMinutes()).padStart(2, '0')}`;

                try {
                    if (firebase && firebase.firestore && typeof firebase.firestore.setLogLevel === 'function') {
                        firebase.firestore.setLogLevel('debug');
                    }
                } catch (e) {
                    console.warn('No se pudo activar setLogLevel:', e);
                }

                await db.collection('projects').doc(projectId).set(projectData);

                progressStatus.textContent = '¬°Proyecto creado exitosamente!';
                setTimeout(() => {
                    alert(`Proyecto "${projectName}" creado con √©xito.`);
                    window.location.href = `proyectos.html`;
                }, 500);

            } catch (error) {
                console.error("Error al crear el proyecto:", error);
                alert("Ocurri√≥ un error al procesar el archivo. Revise la consola para m√°s detalles.");
            } finally {
                document.getElementById('loading-spinner').style.display = 'none';
            }
        });

        // Funci√≥n para sanitizar holidays
        function sanitizeHolidays(holidays) {
            if (!Array.isArray(holidays)) return [];
            return holidays.filter(h => h && typeof h.date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(h.date.trim())).map(h => ({
                date: h.date.trim(),
                name: (h.name || '').trim()
            }));
        }

        function calculateAllTaskDates(projectData) {
            const options = projectData.settings;
            
            const shiftStartTime = projectData.shiftStartTime || '09:00';
            const [shiftStartHour, shiftStartMin] = shiftStartTime.split(':').map(Number);
            const shiftEndTime = projectData.shiftEndTime || '18:00';
            const [shiftEndHour, shiftEndMin] = shiftEndTime.split(':').map(Number);
            const shiftBreakHours = projectData.shiftBreakHours || 1;
            const shiftBreakStartTime = projectData.shiftBreakStartTime || '13:00';
            const [shiftBreakStartHour, shiftBreakStartMin] = shiftBreakStartTime.split(':').map(Number);
            const shiftBreakEndHour = shiftBreakStartHour + shiftBreakHours;
            const shiftBreakEndMin = shiftBreakStartMin;
            
            options.shiftStartHour = shiftStartHour;
            options.shiftEndHour = shiftEndHour;
            options.shiftBreakHours = shiftBreakHours;
            options.shiftBreakStartHour = shiftBreakStartHour;
            options.shiftBreakStartMin = shiftBreakStartMin;
            options.shiftBreakEndHour = shiftBreakEndHour;
            options.shiftBreakEndMin = shiftBreakEndMin;
            options.holidays = sanitizeHolidays(options.holidays || []);
            
            let lastEndDate = moveToNextWorkableMoment(new Date(projectData.startDate.toDate()), options);

            projectData.phases.forEach(phase => {
                phase.tasks.forEach(task => {
                    const taskStartDate = new Date(lastEndDate);
                    task.startDate = firebase.firestore.Timestamp.fromDate(taskStartDate);
                    task.startTime = taskStartDate.getHours().toString().padStart(2, '0') + ':' + taskStartDate.getMinutes().toString().padStart(2, '0');
                    
                    const taskEndDate = getEndDate(new Date(taskStartDate), task.durationHours, options);
                    task.endDate = firebase.firestore.Timestamp.fromDate(taskEndDate);
                    task.endTime = taskEndDate.getHours().toString().padStart(2, '0') + ':' + taskEndDate.getMinutes().toString().padStart(2, '0');
                    
                    lastEndDate = taskEndDate;
                });
            });
        }

        function isWorkDay(date, options) {
            const { skipSaturday, skipSunday, holidays } = options;
            const day = date.getDay();

            if (skipSunday && day === 0) return false;
            if (skipSaturday && day === 6) return false;

            if (holidays && holidays.length > 0) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const dayOfMonth = date.getDate().toString().padStart(2, '0');
                const dateString = `${year}-${month}-${dayOfMonth}`;

                if (holidays.includes(dateString)) {
                    return false;
                }
            }

            return true;
        }

        function moveToNextWorkableMoment(date, options) {
            let newDate = new Date(date);

            if (newDate.getHours() >= (options.shiftEndHour - options.shiftBreakHours)) {
                newDate.setDate(newDate.getDate() + 1);
                newDate.setHours(options.shiftStartHour, 0, 0, 0);
            }

            while (!isWorkDay(newDate, options)) {
                newDate.setDate(newDate.getDate() + 1);
                newDate.setHours(options.shiftStartHour, 0, 0, 0);
            }

            if (newDate.getHours() < options.shiftStartHour) {
                newDate.setHours(options.shiftStartHour, 0, 0, 0);
            }

            if ((newDate.getHours() > options.shiftBreakStartHour || (newDate.getHours() === options.shiftBreakStartHour && newDate.getMinutes() >= options.shiftBreakStartMin)) &&
                (newDate.getHours() < options.shiftBreakEndHour || (newDate.getHours() === options.shiftBreakEndHour && newDate.getMinutes() < options.shiftBreakEndMin))) {
                newDate.setHours(options.shiftBreakEndHour, options.shiftBreakEndMin, 0, 0);
            }

            return newDate;
        }

        function getEndDate(startDate, durationHours, options) {
            const duration = Number(durationHours);
            if (!isFinite(duration) || duration < 0) {
                return new Date(startDate);
            }

            if (duration === 0) {
                return new Date(startDate);
            }

            let remainingMinutes = Math.round(duration * 60);
            let currentDate = new Date(startDate);

            while (remainingMinutes > 0) {
                currentDate = moveToNextWorkableMoment(currentDate, options);

                const currentHour = currentDate.getHours();
                const currentMinute = currentDate.getMinutes();
                const effectiveEndHour = options.shiftEndHour;
                let minutesLeftInDay = (effectiveEndHour - currentHour) * 60 - currentMinute;

                if (currentHour < options.shiftBreakStartHour && options.shiftBreakEndHour < effectiveEndHour) {
                    minutesLeftInDay -= options.shiftBreakHours * 60;
                }

                if (currentHour >= options.shiftBreakStartHour && currentHour < options.shiftBreakEndHour) {
                    minutesLeftInDay = 0;
                }

                if (minutesLeftInDay <= 0) {
                    currentDate.setDate(currentDate.getDate() + 1);
                    currentDate.setHours(options.shiftStartHour, 0, 0, 0);
                    continue;
                }

                const minutesToConsume = Math.min(remainingMinutes, minutesLeftInDay);
                currentDate.setMinutes(currentMinute + minutesToConsume);
                remainingMinutes -= minutesToConsume;
            }

            return currentDate;
        }
    </script>
</body>
</html>
